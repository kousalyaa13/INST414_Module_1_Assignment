```{python}
import pandas as pd
import matplotlib.pyplot as plt
```

# load correct files
```{python}
iso_drugs = pd.read_csv("ISO_DRUG_INFO.txt", sep="$")
reaction_info = pd.read_csv("ORIG_ASCII/REAC25Q4.txt", sep="$")
demo_info = pd.read_csv("ORIG_ASCII/DEMO25Q4.txt", sep="$", low_memory=False)
```

# merge all REAC
```{python}
iso_reactions_all = iso_drugs.merge(
    reaction_info,
    on = "primaryid",
    how = "inner"
)
iso_reactions_all
```

# merge all DEMO
```{python}
iso_full = iso_reactions_all.merge(
    demo_info,
    on = "primaryid",
    how = "left"
)
iso_full
```

# create psychiatric flag
```{python}
iso_full["pt_lower"] = (iso_full["pt"].astype(str).str.lower().str.strip())

iso_full["is_psych_event"] = iso_full["pt_lower"].isin(psych_pt_list)
```

# primaryid may appear multiple times (one per reaction), and we need to verify that demographic fields like sex donâ€™t vary across rows for the same report.
```{python}
iso_full[["primaryid", "sex"]].drop_duplicates().head()
```

# aggregate for report comparision
```{python}
report_level = (iso_full.groupby("primaryid")
    .agg(
        is_psych_report = ("is_psych_event", "max"),
        age = ("age", "first"),
        sex = ("sex", "first")
    ).reset_index()
) report_level
```

```{python}
report_level["is_psych_report"].value_counts()
```

# sex comparision
```{python}
pd.crosstab(report_level["sex"], report_level["is_psych_report"], normalize="index")
```

# age group comparsion
```{python}
bins = [0, 17, 25, 40, 65, 100]
labels = ["<18", "18-25", "26-40", "41-65", "65+"]

report_level["age_group"] = pd.cut(report_level["age"], bins = bins, labels = labels)

pd.crosstab(report_level["age_group"], report_level["is_psych_report"], normalize = "index")

pd.crosstab(report_level["age_group"], report_level["is_psych_report"])
```

# overall psychiatric reporting rate
```{python}
counts = report_level["is_psych_report"].value_counts()

labels = ["Nonpsychiatric", "Psychiatric"]
colors = ["#75729fff", "#C44E52"]

plt.figure()
plt.bar(labels, counts, color = colors)

plt.ylabel("Number of Reports")
plt.title("Isotretinoin Reports: Psychiatric vs Nonpsychiatric AEs")

plt.show()
```

# psychiatric reporting by sex
```{python}
sex_table = pd.crosstab(report_level["sex"], report_level["is_psych_report"], normalize="index")

plt.figure()
plt.bar(sex_table.index, sex_table[True], color = ["#b04c8aff", "#1F3B73"])

plt.ylabel("Proportion with Psychiatric AE")
plt.title("Psychiatric Reporting Proportion by Sex")

plt.ylim(0, 0.4)

plt.show()

```

# psychiatric proportion by age group
```{python}
age_table = pd.crosstab(report_level["age_group"], report_level["is_psych_report"], normalize = "index")

plt.figure()
plt.bar(age_table.index.astype(str), age_table[True], color="#DD8452")

plt.ylabel("Proportion with Psychiatric AE")
plt.title("Psychiatric Reporting Proportion by Age Group")

plt.ylim(0, 0.3)

plt.show()
```